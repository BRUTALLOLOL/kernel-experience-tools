name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install build pybind11 numpy

      - name: Build wheels
        shell: bash
        run: python -m build --wheel

      - name: Rename Linux wheels to manylinux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cd dist
          for file in *.whl; do
            if [[ "$file" == *"linux_x86_64"* ]]; then
              newname="${file//linux_x86_64/manylinux2014_x86_64}"
              mv "$file" "$newname"
              echo "Renamed $file â†’ $newname"
            fi
          done

      - name: Debug - list built wheels (Unix)
        if: runner.os != 'windows-latest'
        shell: bash
        run: |
          echo "=== Built wheels for ${{ runner.os }} Python ${{ matrix.python-version }} ==="
          ls -la dist/
          echo "=== Wheel count: $(ls -1 dist/*.whl 2>/dev/null | wc -l) ==="

      - name: Debug - list built wheels (Windows)
        if: runner.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "=== Built wheels for Windows Python ${{ matrix.python-version }} ==="
          Get-ChildItem -Path dist\
          $wheelCount = (Get-ChildItem -Path dist\*.whl -ErrorAction SilentlyContinue).Count
          Write-Host "=== Wheel count: $wheelCount ==="

      - name: Store wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ runner.os }}-${{ matrix.python-version }}
          path: dist/*.whl
          if-no-files-found: error

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pybind11 numpy

      - name: Build sdist
        run: python -m build --sdist

      - name: Debug - list built sdist
        run: |
          echo "=== Built source distribution ==="
          ls -la dist/
          echo "=== sdist count: $(ls -1 dist/*.tar.gz 2>/dev/null | wc -l) ==="

      - name: Store sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          if-no-files-found: error

  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          merge-multiple: false

      - name: Debug - show downloaded artifacts structure
        run: |
          echo "=== DOWNLOADED ARTIFACTS STRUCTURE ==="
          find downloaded-artifacts -type f | sort
          echo ""
          echo "=== Directory tree ==="
          ls -laR downloaded-artifacts/

      - name: Create clean dist directory
        run: |
          rm -rf dist
          mkdir -p dist
          echo "=== Created clean dist directory ==="

      - name: Copy all wheel files (any platform)
        run: |
          echo "=== COPYING WHEEL FILES ==="
          
          # Find all .whl files recursively and copy them to dist/
          wheel_files=$(find downloaded-artifacts -name "*.whl" -type f)
          
          if [ -z "$wheel_files" ]; then
            echo "ERROR: No wheel files found!"
            exit 1
          fi
          
          echo "$wheel_files" | while read -r file; do
            cp "$file" dist/
            echo "Copied: $file"
          done
          
          # Count copied files
          wheel_count=$(ls -1 dist/*.whl 2>/dev/null | wc -l)
          echo ""
          echo "Total wheel files copied: $wheel_count"
          echo ""
          echo "=== Wheels in dist directory ==="
          ls -la dist/*.whl

      - name: Copy source distribution
        run: |
          echo "=== COPYING SOURCE DISTRIBUTION ==="
          
          # Find all .tar.gz files recursively
          sdist_files=$(find downloaded-artifacts -name "*.tar.gz" -type f)
          
          if [ -z "$sdist_files" ]; then
            echo "ERROR: No source distribution files found!"
            exit 1
          fi
          
          echo "$sdist_files" | while read -r file; do
            cp "$file" dist/
            echo "Copied: $file"
          done
          
          # Count copied files
          sdist_count=$(ls -1 dist/*.tar.gz 2>/dev/null | wc -l)
          echo ""
          echo "Total source distributions copied: $sdist_count"
          echo ""
          echo "=== Source distributions in dist directory ==="
          ls -la dist/*.tar.gz

      - name: Clean metadata from source distributions
        run: |
          echo "=== CLEANING METADATA FROM SOURCE DISTRIBUTIONS ==="
          
          for tgz in dist/*.tar.gz; do
            if [ -f "$tgz" ]; then
              echo ""
              echo "Processing: $(basename "$tgz")"
              
              # Create temp directory
              temp_dir=$(mktemp -d)
              
              # Extract archive
              tar -xzf "$tgz" -C "$temp_dir"
              
              # Find package directory (first directory inside temp_dir)
              pkg_dir=$(find "$temp_dir" -maxdepth 1 -type d | grep -v "^$temp_dir$" | head -1)
              
              if [ -f "$pkg_dir/PKG-INFO" ]; then
                echo "  Cleaning PKG-INFO..."
                
                # Show original problematic fields if any
                if grep -q "license-file\|license-expression" "$pkg_dir/PKG-INFO"; then
                  echo "  Found problematic fields:"
                  grep "license-file\|license-expression" "$pkg_dir/PKG-INFO" || true
                fi
                
                # Remove problematic fields
                sed -i '/license-file/d' "$pkg_dir/PKG-INFO"
                sed -i '/license-expression/d' "$pkg_dir/PKG-INFO"
                
                # Ensure License field exists
                if ! grep -q "^License:" "$pkg_dir/PKG-INFO"; then
                  echo "License: MIT" >> "$pkg_dir/PKG-INFO"
                  echo "  Added License: MIT field"
                fi
                
                echo "  PKG-INFO cleaned successfully"
              else
                echo "  WARNING: No PKG-INFO found"
              fi
              
              # Create new archive
              pkg_basename=$(basename "$pkg_dir")
              (cd "$temp_dir" && tar -czf "$GITHUB_WORKSPACE/dist/$pkg_basename.tar.gz" "$pkg_basename")
              
              # Clean up
              rm -rf "$temp_dir"
              echo "  Repackaged: $(basename "$tgz")"
            fi
          done

      - name: Verify cleaned metadata
        run: |
          echo "=== VERIFYING CLEANED METADATA ==="
          
          for tgz in dist/*.tar.gz; do
            if [ -f "$tgz" ]; then
              echo ""
              echo "Checking: $(basename "$tgz")"
              echo "--- PKG-INFO content (first 15 lines) ---"
              tar -xOzf "$tgz" "*/PKG-INFO" 2>/dev/null | head -15
              
              # Check for problematic fields
              if tar -xOzf "$tgz" "*/PKG-INFO" 2>/dev/null | grep -q "license-file\|license-expression"; then
                echo "âŒ ERROR: Problematic fields still present!"
                exit 1
              else
                echo "âœ… No problematic fields found"
              fi
              echo "---"
            fi
          done

      - name: List all files ready for upload
        run: |
          echo "=== FILES READY FOR UPLOAD ==="
          echo "Total files: $(ls -1 dist/ | wc -l)"
          echo ""
          ls -la dist/
          echo ""
          echo "=== File types ==="
          file dist/* || true

      - name: Set up Python for upload
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install twine
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade twine build

      - name: Run twine check on all files
        run: |
          echo "=== RUNNING TWINE CHECK ==="
          cd dist
          
          # Check each file individually
          for file in *; do
            echo ""
            echo "Checking: $file"
            if twine check "$file" 2>&1; then
              echo "âœ… Passed: $file"
            else
              echo "âŒ Failed: $file"
              exit 1
            fi
          done
          
          cd ..

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "=== PUBLISHING TO PyPI ==="
          echo "Uploading $(ls -1 dist/ | wc -l) files..."
          echo ""
          
          # Upload files one by one for better error tracking
          for file in dist/*; do
            if [ -f "$file" ]; then
              echo "Uploading: $(basename "$file")"
              echo "Size: $(du -h "$file" | cut -f1)"
              
              if twine upload --verbose "$file"; then
                echo "âœ… Successfully uploaded: $(basename "$file")"
              else
                echo "âŒ Failed to upload: $(basename "$file")"
                echo "Continuing with next file..."
              fi
              echo ""
            fi
          done
          
          echo "=== UPLOAD PROCESS COMPLETED ==="

      - name: Final success message
        if: success()
        run: |
          echo "ðŸŽ‰ðŸŽ‰ðŸŽ‰ SUCCESS! ðŸŽ‰ðŸŽ‰ðŸŽ‰"
          echo "Package: kernel-experience-tools"
          
          # Extract version from first wheel file
          version=$(ls dist/*.whl 2>/dev/null | head -1 | grep -oP 'kernel_experience_tools-\K[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "Version: $version"
          echo ""
          echo "Check at: https://pypi.org/project/kernel-experience-tools/$version/"
          echo ""
          echo "Install with: pip install kernel-experience-tools==$version"
