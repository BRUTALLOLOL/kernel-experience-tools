name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-wheels:
    name: Build wheels on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pybind11 numpy

      - name: Build wheels
        run: python -m build --wheel

      - name: Rename Linux wheels to manylinux
        if: runner.os == 'Linux'
        shell: bash
        run: |
          cd dist
          for file in *.whl; do
            if [[ "$file" == *"linux_x86_64"* ]]; then
              newname="${file//linux_x86_64/manylinux2014_x86_64}"
              mv "$file" "$newname"
              echo "Renamed $file → $newname"
            fi
          done

      - name: Debug - list built wheels
        run: |
          echo "=== Built wheels for ${{ runner.os }} Python ${{ matrix.python-version }} ==="
          ls -la dist/
          echo "=== Wheel count: $(ls -1 dist/*.whl 2>/dev/null | wc -l) ==="

      - name: Store wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ runner.os }}-${{ matrix.python-version }}
          path: dist/*.whl
          if-no-files-found: error

  build-sdist:
    name: Build source distribution
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build pybind11 numpy

      - name: Build sdist
        run: python -m build --sdist

      - name: Debug - list built sdist
        run: |
          echo "=== Built source distribution ==="
          ls -la dist/
          echo "=== sdist count: $(ls -1 dist/*.tar.gz 2>/dev/null | wc -l) ==="

      - name: Store sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz
          if-no-files-found: error

  publish:
    name: Publish to PyPI
    needs: [build-wheels, build-sdist]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
          merge-multiple: false

      - name: Debug - list downloaded artifacts structure
        run: |
          echo "=== DOWNLOADED ARTIFACTS STRUCTURE ==="
          find downloaded-artifacts -type f | sort
          echo ""
          echo "=== Directory tree ==="
          ls -laR downloaded-artifacts/

      - name: Create clean dist directory
        run: |
          rm -rf dist
          mkdir -p dist
          echo "=== Created clean dist directory ==="

      - name: Collect all wheel files
        run: |
          echo "=== COLLECTING WHEEL FILES ==="
          # Ищем все wheel файлы в downloaded-artifacts
          wheel_count=0
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              cp "$file" dist/
              echo "Copied: $file"
              ((wheel_count++))
            fi
          done < <(find downloaded-artifacts -name "*.whl" -type f)
          
          echo "Total wheel files copied: $wheel_count"
          echo ""
          echo "=== Wheels in dist directory ==="
          ls -la dist/*.whl 2>/dev/null || echo "No wheel files found"

      - name: Process and clean source distributions
        run: |
          echo "=== PROCESSING SOURCE DISTRIBUTIONS ==="
          sdist_count=0
          
          # Обрабатываем каждый tar.gz файл
          while IFS= read -r tgz; do
            if [ -f "$tgz" ]; then
              echo ""
              echo "Processing: $tgz"
              filename=$(basename "$tgz")
              echo "Filename: $filename"
              
              # Создаем временную директорию
              temp_dir=$(mktemp -d)
              echo "Temp dir: $temp_dir"
              
              # Распаковываем архив
              tar -xzf "$tgz" -C "$temp_dir"
              echo "Extracted to temp dir"
              
              # Находим директорию пакета
              pkg_dir=$(find "$temp_dir" -maxdepth 1 -type d | grep -v "^$temp_dir$" | head -1)
              echo "Package directory: $pkg_dir"
              
              if [ -f "$pkg_dir/PKG-INFO" ]; then
                echo "Found PKG-INFO, cleaning..."
                
                # Показываем оригинальное содержимое
                echo "--- Original PKG-INFO (first 20 lines) ---"
                head -20 "$pkg_dir/PKG-INFO"
                
                # Удаляем проблемные поля
                sed -i '/license-file/d' "$pkg_dir/PKG-INFO"
                sed -i '/license-expression/d' "$pkg_dir/PKG-INFO"
                
                # Добавляем License: MIT если нет
                if ! grep -q "^License:" "$pkg_dir/PKG-INFO"; then
                  echo "License: MIT" >> "$pkg_dir/PKG-INFO"
                fi
                
                # Показываем очищенное содержимое
                echo "--- Cleaned PKG-INFO (first 20 lines) ---"
                head -20 "$pkg_dir/PKG-INFO"
              else
                echo "WARNING: No PKG-INFO found in $pkg_dir"
              fi
              
              # Создаем новый архив
              echo "Creating new archive: dist/$filename"
              (cd "$temp_dir" && tar -czf "$GITHUB_WORKSPACE/dist/$filename" "$(basename "$pkg_dir")")
              
              # Проверяем созданный архив
              if [ -f "dist/$filename" ]; then
                echo "✓ Successfully created: dist/$filename"
                echo "New archive size: $(du -h "dist/$filename" | cut -f1)"
                ((sdist_count++))
              else
                echo "✗ Failed to create: dist/$filename"
              fi
              
              # Очищаем временную директорию
              rm -rf "$temp_dir"
              echo "Cleaned up temp dir"
            fi
          done < <(find downloaded-artifacts -name "*.tar.gz" -type f)
          
          echo ""
          echo "Total source distributions processed: $sdist_count"

      - name: Final verification of dist directory
        run: |
          echo "=== FINAL DIST DIRECTORY CONTENTS ==="
          echo "Location: $PWD/dist"
          echo ""
          echo "Directory listing:"
          ls -la dist/
          echo ""
          echo "File details:"
          for file in dist/*; do
            if [ -f "$file" ]; then
              echo "File: $(basename "$file")"
              echo "  Size: $(du -h "$file" | cut -f1)"
              echo "  Type: $(file "$file")"
              echo "  Permissions: $(stat -c '%a' "$file")"
              echo ""
            fi
          done
          
          # Подсчет файлов
          wheel_count=$(ls -1 dist/*.whl 2>/dev/null | wc -l)
          sdist_count=$(ls -1 dist/*.tar.gz 2>/dev/null | wc -l)
          total_count=$((wheel_count + sdist_count))
          
          echo "=== SUMMARY ==="
          echo "Wheel files: $wheel_count"
          echo "Source distributions: $sdist_count"
          echo "Total files: $total_count"
          
          if [ $total_count -eq 0 ]; then
            echo "ERROR: No files found in dist directory!"
            exit 1
          fi

      - name: Verify metadata in cleaned source distributions
        run: |
          echo "=== VERIFYING METADATA IN CLEANED SDISTS ==="
          for tgz in dist/*.tar.gz; do
            if [ -f "$tgz" ]; then
              echo ""
              echo "Checking: $(basename "$tgz")"
              echo "--- PKG-INFO content ---"
              tar -xOzf "$tgz" "*/PKG-INFO" 2>/dev/null || echo "Failed to extract PKG-INFO"
              echo "--- End of PKG-INFO ---"
              
              # Проверяем наличие проблемных полей
              if tar -xOzf "$tgz" "*/PKG-INFO" 2>/dev/null | grep -q "license-file\|license-expression"; then
                echo "⚠️  WARNING: Found problematic fields in metadata!"
              else
                echo "✅ No problematic fields found"
              fi
            fi
          done

      - name: Verify wheel metadata
        run: |
          echo "=== VERIFYING WHEEL METADATA ==="
          pip install wheel
          for whl in dist/*.whl; do
            if [ -f "$whl" ]; then
              echo ""
              echo "Checking: $(basename "$whl")"
              echo "--- METADATA content ---"
              python -m wheel metadata "$whl" 2>/dev/null || echo "Failed to extract metadata"
              
              # Распаковываем и проверяем METADATA
              temp_whl_dir=$(mktemp -d)
              unzip -q "$whl" -d "$temp_whl_dir"
              if [ -f "$temp_whl_dir/*.dist-info/METADATA" ]; then
                cat "$temp_whl_dir"/*.dist-info/METADATA | head -20
              fi
              rm -rf "$temp_whl_dir"
              echo "--- End of METADATA ---"
            fi
          done

      - name: Set up Python for upload
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install twine
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade twine build

      - name: Run twine check
        run: |
          echo "=== RUNNING TWINE CHECK ==="
          cd dist
          echo "Files in dist:"
          ls -la
          echo ""
          echo "Twine check output:"
          twine check * 2>&1 || echo "Twine check completed with warnings"
          cd ..

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          echo "=== PUBLISHING TO PyPI ==="
          echo "Files to upload:"
          ls -la dist/
          echo ""
          echo "Starting upload..."
          
          # Загружаем файлы по одному для лучшей отладки
          for file in dist/*; do
            if [ -f "$file" ]; then
              echo ""
              echo "Uploading: $(basename "$file")"
              twine upload --verbose "$file"
              if [ $? -eq 0 ]; then
                echo "✓ Successfully uploaded: $(basename "$file")"
              else
                echo "✗ Failed to upload: $(basename "$file")"
                exit 1
              fi
            fi
          done
          
          echo ""
          echo "✓ All files uploaded successfully to PyPI!"

      - name: Verify upload
        if: success()
        run: |
          echo "=== VERIFYING UPLOAD ==="
          # Получаем версию из первого wheel файла
          version=$(ls dist/*.whl 2>/dev/null | head -1 | grep -oP 'kernel_experience_tools-\K[0-9]+\.[0-9]+\.[0-9]+' || echo "unknown")
          echo "Package version: $version"
          echo ""
          echo "Check at: https://pypi.org/project/kernel-experience-tools/$version/"
